---
title: "stat 350 final project"
author: "GROUP 8"
date: "2020/11/24"
output: html_document
---

```{r}

library(readr)
library(MASS)
library(stringr)
library(car)
library(StepReg)


data3 <- read_csv("Car details v3.csv")
dim(data3) # 8128 13
Car_details_v3 <- data3[complete.cases(data3), ]
head(Car_details_v3)
names(Car_details_v3) # "name" "year" "selling_price" "km_driven" "fuel" "seller_type" "transmission" "owner" "mileage" "engine" "max_power" "torque" "seats"  
dim(Car_details_v3) # 7906 13


Car_details_v3$fuel=as.factor(Car_details_v3$fuel)
Car_details_v3$seller_type=as.factor(Car_details_v3$seller_type)
Car_details_v3$transmission=as.factor(Car_details_v3$transmission)
Car_details_v3$owner=as.factor(Car_details_v3$owner)


years = 2020 - Car_details_v3$year
Name = str_split_fixed(Car_details_v3$name, " ", 2)
Mileage= str_split_fixed(Car_details_v3$mileage, " ", 2)
Engine= str_split_fixed(Car_details_v3$engine, " ", 2)
Max_power= str_split_fixed(Car_details_v3$max_power, " ", 2)

sub_1 = cbind(Name,years,Mileage,Engine,Max_power)
sub_2 = sub_1[,-c(2,5,7,9)]
car <- cbind(sub_2,Car_details_v3)

colnames(car)[which(names(car) == "V1")] <- "manufacturer"
colnames(car)[which(names(car) == "V3")] <- "Mileage"
colnames(car)[which(names(car) == "V4")] <- "Engine"
colnames(car)[which(names(car) == "V5")] <- "Max_power"
car <- subset(car, select = -c(name,year, mileage, engine, max_power))
unique(car$manufacturer)

car$manufacturer = as.character(car$manufacturer)
car$manufacturer[car$manufacturer %in% c("Maruti","Honda","Toyota","Mitsubishi","Nissan","Lexus","Isuzu")] <- "Japan"

car$manufacturer[car$manufacturer %in% c("Skoda","Mercedes-Benz","Audi","Volkswagen","BMW")] <- "Germany"

car$manufacturer[car$manufacturer %in% c("Renault", "Land", "MG", "Volvo", "Fiat", "Opel","Jaguar")] <- "otherEurope"

car$manufacturer[car$manufacturer %in% c( "Hyudai", "Mahindra", "Tata", "Datsun", "Daewoo", "Kia", "Force", "Ashok","Hyundai")] <- "otherAsia"

car$manufacturer[car$manufacturer %in% c("Ambassador","Ford","Chevrolet","Jeep")] <- "US"



head(car)
car$manufacturer=as.factor(car$manufacturer)
car$years = as.double(car$years)
car$Mileage = as.double(car$Mileage)
car$Engine = as.double(car$Engine)
car$Max_power = as.double(car$Max_power)



#Data Deascripution

library(ggplot2)

ggplot(car) +
  geom_bar(mapping = aes(x=manufacturer,fill=seller_type))
ggplot(car) +
  geom_bar(mapping = aes(x=fuel,fill=transmission))
ggplot(car) +
  geom_bar(mapping = aes(x=transmission,fill=fuel))
ggplot(car) +
  geom_bar(mapping = aes(x=seller_type,fill=manufacturer))
ggplot(car) +
  geom_bar(mapping = aes(x=seller_type,fill=owner))
ggplot(car) +
  geom_bar(mapping = aes(x=owner,fill=seller_type))


#summary(car$manufacturer)


```

```{r}
mydata <- car[, -c(1,8,9,10,11,12)]
head(mydata)
pairs(mydata)
```


```{r}



car <- subset(car, select = -c(torque))
full.model = lm(selling_price ~., data = car)
#summary(full.model)
full.model_1= lm(selling_price ~ 1 , data = car)
step(full.model, direction = "backward")
step(full.model_1, direction = "forward",scop = formula(full.model))
step(full.model, direction = "both")

car <- subset(car, select = -c(seats, Max_power))

```



```{r}

lm1 <- lm(selling_price ~ .,data = car) 
summary(lm1)
anova(lm1)
plot(lm1)
vcov(lm1)
vif(lm1)
confint(lm1, level = 0.95)


# huber
robust_huber.lm <- rlm(selling_price ~., data = car, psi = psi.huber)
summary(robust_huber.lm)
plot(robust_huber.lm)
(weights <- robust_huber.lm$w)
plot(weights, main = "huber: Weights v.s. the Observation Number")




# Prediction
set.seed(1168)
nsamp = ceiling(0.8*length(car$selling_price))
training_samps = sample(c(1:length(car$selling_price)),nsamp)
training_samps = sort(training_samps)
train_data <- car[training_samps, ]
test_data <- car[-training_samps, ]
train.lm <- lm(selling_price ~ ., data = train_data)
summary(train.lm)
preds <- predict(train.lm, test_data)
plot(test_data$selling_price, preds)
abline(c(0,1))


```
