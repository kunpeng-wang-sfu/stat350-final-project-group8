---
title: "stat 350 final project"
author: "GROUP 8"
date: "2020/11/24"
output: html_document
---

```{r}

library(readr)
library(MASS)
library(stringr)
library(car)


data3 <- read_csv("Car details v3.csv")
dim(data3) # 8128 13
Car_details_v3 <- data3[complete.cases(data3), ]
head(Car_details_v3)
names(Car_details_v3) # "name" "year" "selling_price" "km_driven" "fuel" "seller_type" "transmission" "owner" "mileage" "engine" "max_power" "torque" "seats"  
dim(Car_details_v3) # 7906 13


Car_details_v3$fuel=as.factor(Car_details_v3$fuel)
Car_details_v3$seller_type=as.factor(Car_details_v3$seller_type)
Car_details_v3$transmission=as.factor(Car_details_v3$transmission)
Car_details_v3$owner=as.factor(Car_details_v3$owner)


years = 2020 - Car_details_v3$year
Name = str_split_fixed(Car_details_v3$name, " ", 2)
Mileage= str_split_fixed(Car_details_v3$mileage, " ", 2)
Engine= str_split_fixed(Car_details_v3$engine, " ", 2)
Max_power= str_split_fixed(Car_details_v3$max_power, " ", 2)

sub_1 = cbind(Name,years,Mileage,Engine,Max_power)
sub_2 = sub_1[,-c(2,5,7,9)]
car <- cbind(sub_2,Car_details_v3)

colnames(car)[which(names(car) == "V1")] <- "manufacturer"
colnames(car)[which(names(car) == "V3")] <- "Mileage"
colnames(car)[which(names(car) == "V4")] <- "Engine"
colnames(car)[which(names(car) == "V5")] <- "Max_power"
car <- subset(car, select = -c(name,year, mileage, engine, max_power))
unique(car$manufacturer)
#japan <-c("Maruti","Honda","Toyota","Mitsubishi","Nissan","Lexus","Isuzu")
#car[manufacturer %in% japan, country := "japan"]
car$manufacturer = as.character(car$manufacturer)
car$manufacturer[car$manufacturer %in% c("Maruti","Honda","Toyota","Mitsubishi","Nissan","Lexus","Isuzu")] <- "japan"

car$manufacturer[car$manufacturer %in% c("Skoda","Mercedes-Benz","Audi","Volkswagen","BMW")] <- "europe"

car$manufacturer[car$manufacturer %in% c("Ford","Chevrolet","Jeep","Volkswagen","BMW")] <- "us"
car$manufacturer[car$manufacturer %in% c("Hyundai","Renault","Mahindra","Tata","Datsun","Land","MG","Volvo","Daewoo","Kia","Fiat","Force","Ashok","Opel")] <- "other"

head(car)
car$manufacturer=as.factor(car$manufacturer) #no test may changed: frank wang 

car$years = as.double(car$years)
car$Mileage = as.double(car$Mileage)
car$Engine = as.double(car$Engine)
car$Max_power = as.double(car$Max_power)

mydata <- car[, -c(1,8,9,10,11,12)]
head(mydata)
pairs(mydata)

full.model = lm(selling_price ~ .- torque -manufacturer, data = car)
step.model_for = stepAIC(full.model, direction = "forward", trace = FALSE)
step.model_back = stepAIC(full.model, direction = "backward", trace = FALSE)
step.model_both= stepAIC(full.model, direction = "both", trace = FALSE)

summary(step.model_for)
summary(step.model_back)
summary(step.model_both)

lm1 <- lm(selling_price ~ .  - torque - manufacturer, data = car)
summary(lm1)
anova(lm1)
plot(lm1)
vcov(lm1)
vif(lm1)
confint(lm1, level = 0.95)
robust.lm <- rlm(selling_price ~ . - torque, data = car, psi = psi.huber)
summary(robust.lm)
plot(robust.lm)
(weights <- robust.lm$w)
plot(weights, main = "Weights v.s. the Observation Number")


set.seed(1168)
nsamp = ceiling(0.8*length(car$selling_price))
training_samps = sample(c(1:length(car$selling_price)),nsamp)
training_samps = sort(training_samps)
train_data <- car[training_samps, ]
test_data <- car[-training_samps, ]
train.lm <- lm(selling_price ~ .  - torque - manufacturer,
               data = train_data)
summary(train.lm)
preds <- predict(train.lm, test_data[,-1])
plot(test_data$selling_price, preds, xlim=c(15,40), ylim=c(15,40))
abline(c(0,1))


```



















